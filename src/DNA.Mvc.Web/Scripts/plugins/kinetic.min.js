/**
 * KineticJS JavaScript Library v3.5.2
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Jan 14 2012
 *
 * Copyright (C) 2012 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.Layer=function(a,c){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=a.width;this.canvas.height=a.height;this.canvas.style.position="absolute";this.shapes=[];if(c){var b=this;this.context.stroke=function(){};this.context.fill=function(){};this.context.fillRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.strokeRect=function(e,g,f,d){b.context.rect(e,g,f,d)};this.context.drawImage=function(){};this.context.fillText=function(){};this.context.strokeText=function(){}}a.container.appendChild(this.canvas)};Kinetic.Layer.prototype.clear=function(){var b=this.getContext();var a=this.getCanvas();b.clearRect(0,0,a.width,a.height)};Kinetic.Layer.prototype.getCanvas=function(){return this.canvas};Kinetic.Layer.prototype.getContext=function(){return this.context};Kinetic.Layer.prototype.getShapes=function(){return this.shapes};Kinetic.Layer.prototype.draw=function(){this.clear();var a=this.getContext();for(var b=0;b<this.getShapes().length;b++){this.getShapes()[b].draw(this)}};Kinetic.Layer.prototype.setIndices=function(){var a=this.getShapes();for(var b=0;b<a.length;b++){a[b].index=b}};Kinetic.Stage=function(b,d,a){this.container=document.getElementById(b);this.width=d;this.height=a;this.scale={x:1,y:1};this.idCounter=0;this.dblClickWindow=400;this.targetShape={};this.clickStart=false;this.mousePos=null;this.mouseDown=false;this.mouseUp=false;this.touchPos=null;this.touchStart=false;this.touchEnd=false;var e=this;this.layers={buffer:new Kinetic.Layer(e),backstage:new Kinetic.Layer(e,true),stage:new Kinetic.Layer(e),background:new Kinetic.Layer(e),props:new Kinetic.Layer(e),extras:new Kinetic.Layer(e),actors:new Kinetic.Layer(e)};this.layers.buffer.getCanvas().style.display="none";this.layers.backstage.getCanvas().style.display="none";this.listen();this.addEventListener("mouseout",function(h){e.shapeDragging=undefined},false);var c=[{end:"mouseup",move:"mousemove"},{end:"touchend",move:"touchmove"}];for(var g=0;g<c.length;g++){var f=c[g];(function(){var h=f;e.on(h.move,function(j){if(e.shapeDragging){var m=e.shapeDragging.eventListeners.ondragmove;if(m){var l=m;for(var k=0;k<l.length;k++){l[k].func.apply(e.shapeDragging,[j])}}var n=h.move=="mousemove"?e.getMousePosition():e.getTouchPosition();if(e.shapeDragging.drag.x){e.shapeDragging.x=n.x-e.shapeDragging.offset.x}if(e.shapeDragging.drag.y){e.shapeDragging.y=n.y-e.shapeDragging.offset.y}e.layers.actors.draw()}},false);e.on(h.end,function(j){if(e.shapeDragging){var m=e.shapeDragging.eventListeners.ondragend;if(m){var l=m;for(var k=0;k<l.length;k++){l[k].func.apply(e.shapeDragging,[j])}}}e.shapeDragging=undefined})})()}this.on("touchend",function(h){if(e.shapeDragging){var l=e.shapeDragging.eventListeners.ondragend;if(l){var k=l;for(var j=0;j<k.length;j++){k[j].func.apply(e.shapeDragging,[h])}}}e.shapeDragging=undefined})};Kinetic.Stage.prototype.getLayer=function(a){return this.layers[a]};Kinetic.Stage.prototype.setSize=function(d,a){var e=this.layers;for(var c in e){var b=e[c];b.getCanvas().width=d;b.getCanvas().height=a;b.draw()}};Kinetic.Stage.prototype.setScale=function(b,a){if(a){this.scale.x=b;this.scale.y=a}else{this.scale.x=b;this.scale.y=b}};Kinetic.Stage.prototype.toDataURL=function(h){var b=this.layers.buffer;var a=b.getContext();var d=this.layers.stage;var g=this.layers.props;var e=this.layers.actors;var f=[d,g,e];function c(k){var j=f[k].getCanvas().toDataURL();var i=new Image();i.onload=function(){a.drawImage(this,0,0);k++;if(k<f.length){c(k)}else{h(b.getCanvas().toDataURL())}};i.src=j}b.clear();c(0)};Kinetic.Stage.prototype.clear=function(){this.layers.stage.clear()};Kinetic.Stage.prototype.draw=function(){this.layers.background.draw();this.layers.props.draw();this.layers.extras.draw();this.layers.actors.draw()};Kinetic.Stage.prototype.remove=function(b){var c=b.getLayer();var a=c.getShapes();for(var e=0;e<a.length;e++){var d=a[e].id;if(d==b.id){b.getLayer().getShapes().splice(e,1)}}c.setIndices()};Kinetic.Stage.prototype.removeShapes=function(){this.layers.background.shapes=[];this.layers.props.shapes=[];this.layers.extras.shapes=[];this.layers.actors.shapes=[]};Kinetic.Stage.prototype.getCanvas=function(){return this.layers.stage.getCanvas()};Kinetic.Stage.prototype.getContext=function(){return this.layers.stage.getContext()};Kinetic.Stage.prototype.on=function(a,b){this.container.addEventListener(a,b)};Kinetic.Stage.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Stage.prototype.add=function(a){a.stage=this;a.layer=this.layers[a.layerKey];a.layer.shapes.push(a);a.index=a.layer.shapes.length-1;a.id=this.idCounter++;a.draw(a.layer)};Kinetic.Stage.prototype.handleEvent=function(a){if(!a){a=window.event}this.setMousePosition(a);this.setTouchPosition(a);var f=this.layers.backstage;var c=f.getContext();var d=this;f.clear();for(var e=this.getEventShapes().length-1;e>=0;e--){var b=this.getEventShapes()[e];(function(){var g=b;g.draw(f);var m=d.getUserPosition();var l=g.eventListeners;if(g.visible&&m!==null&&c.isPointInPath(m.x,m.y)){if(d.mouseDown){d.mouseDown=false;d.clickStart=true;if(l.onmousedown){var k=l.onmousedown;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(d.mouseUp){d.mouseUp=false;if(l.onmouseup){var k=l.onmouseup;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(d.clickStart){if(l.onclick){var k=l.onclick;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(l.ondblclick&&g.inDoubleClickWindow){var k=l.ondblclick;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},d.dblClickWindow)}e=-1}else{if(d.touchStart){d.touchStart=false;if(l.touchstart){var k=l.touchstart;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}if(l.ondbltap&&g.inDoubleClickWindow){var k=l.ondbltap;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},d.dblClickWindow);e=-1}else{if(d.touchEnd){d.touchEnd=false;if(l.touchend){var k=l.touchend;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(l.touchmove){var k=l.touchmove;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}e=-1}else{if(d.targetShape.id===undefined||(d.targetShape.id!=g.id&&d.targetShape.getZIndex()<g.getZIndex())){var h=d.targetShape.eventListeners;if(h&&h.onmouseout){var k=h.onmouseout;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}d.targetShape=g;if(l.onmouseover){var k=l.onmouseover;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}else{if(l.onmousemove){var k=l.onmousemove;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}e=-1}}}}}}}}else{if(d.targetShape.id==g.id){d.targetShape={};if(l.onmouseout){var k=l.onmouseout;for(var j=0;j<k.length;j++){k[j].func.apply(g,[a])}}e=-1}}}())}};Kinetic.Stage.prototype.listen=function(){var a=this;this.container.addEventListener("mousedown",function(b){a.mouseDown=true;a.handleEvent(b)},false);this.container.addEventListener("mousemove",function(b){a.mouseUp=false;a.mouseDown=false;a.handleEvent(b)},false);this.container.addEventListener("mouseup",function(b){a.mouseUp=true;a.mouseDown=false;a.handleEvent(b);a.clickStart=false},false);this.container.addEventListener("mouseover",function(b){a.handleEvent(b)},false);this.container.addEventListener("mouseout",function(b){a.mousePos=null},false);this.container.addEventListener("touchstart",function(b){b.preventDefault();a.touchStart=true;a.handleEvent(b)},false);this.container.addEventListener("touchmove",function(b){b.preventDefault();a.handleEvent(b)},false);this.container.addEventListener("touchend",function(b){b.preventDefault();a.touchEnd=true;a.handleEvent(b)},false)};Kinetic.Stage.prototype.getMousePosition=function(a){return this.mousePos};Kinetic.Stage.prototype.getTouchPosition=function(a){return this.touchPos};Kinetic.Stage.prototype.getUserPosition=function(a){return this.getTouchPosition()||this.getMousePosition()};Kinetic.Stage.prototype.setMousePosition=function(a){var c=a.clientX-this.getContainerPosition().left+window.pageXOffset;var b=a.clientY-this.getContainerPosition().top+window.pageYOffset;this.mousePos={x:c,y:b}};Kinetic.Stage.prototype.setTouchPosition=function(c){if(c.touches!==undefined&&c.touches.length==1){var d=c.touches[0];var b=d.clientX-this.getContainerPosition().left+window.pageXOffset;var a=d.clientY-this.getContainerPosition().top+window.pageYOffset;this.touchPos={x:b,y:a}}};Kinetic.Stage.prototype.getContainerPosition=function(){var c=this.container;var b=0;var a=0;while(c&&c.tagName!="BODY"){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}};Kinetic.Stage.prototype.getContainer=function(){return this.container};Kinetic.Stage.prototype.getEventShapes=function(){return(this.layers.props.shapes).concat(this.layers.actors.shapes)};Kinetic.Stage.prototype.getShapes=function(){return(this.layers.background.shapes).concat(this.layers.props.shapes,this.layers.extras.shapes,this.layers.actors.shapes)};Kinetic.Stage.prototype.moveShapes=function(d,b){var c=this.layers[d];var e=this.layers[b];var a=c.shapes;for(var f=0;f<a.length;f++){a[f].layer=e}e.shapes=(e.shapes).concat(c.shapes);c.shapes=[];e.setIndices()};Kinetic.Shape=function(a,b){this.drawFunc=a;if(b){this.layerKey=b;if(b!="background"){this.layerKey+="s"}}else{this.layerKey="actors"}this.x=0;this.y=0;this.scale={x:1,y:1};this.rotation=0;this.lastX=0;this.lastY=0;this.lastRotation=0;this.lastScale={x:1,y:1};this.eventListeners={};this.visible=true;this.drag={x:false,y:false}};Kinetic.Shape.prototype.getContext=function(){return this.tempLayer.getContext()};Kinetic.Shape.prototype.getCanvas=function(){return this.tempLayer.getCanvas()};Kinetic.Shape.prototype.getStage=function(){return this.stage};Kinetic.Shape.prototype.draw=function(c){if(this.visible){var a=this.getStage();var b=c.getContext();b.save();if(a.scale.x!=1||a.scale.y!=1){b.scale(a.scale.x,a.scale.y)}b.save();if(this.x!==0||this.y!==0){b.translate(this.x,this.y)}if(this.rotation!==0){b.rotate(this.rotation)}if(this.scale.x!=1||this.scale.y!=1){b.scale(this.scale.x,this.scale.y)}this.tempLayer=c;this.drawFunc.call(this);b.restore();b.restore()}};Kinetic.Shape.prototype.initDrag=function(){var b=this;var a=["mousedown","touchstart"];for(var d=0;d<a.length;d++){var c=a[d];(function(){var e=c;b.on(e+".initdrag",function(f){var g=b.getStage();var l=g.getUserPosition();if(l){g.shapeDragging=b;g.shapeDragging.offset={};g.shapeDragging.offset.x=l.x-b.x;g.shapeDragging.offset.y=l.y-b.y;var k=b.eventListeners.ondragstart;if(k){var j=k;for(var h=0;h<j.length;h++){j[h].func.apply(b,[f])}}}})})()}};Kinetic.Shape.prototype.dragCleanup=function(){if(!this.drag.x&&!this.drag.y){this.off("mousedown.initdrag");this.off("touchstart.initdrag")}};Kinetic.Shape.prototype.draggable=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag={x:true,y:true};if(a){this.initDrag()}}else{this.drag={x:false,y:false};this.dragCleanup()}};Kinetic.Shape.prototype.draggableX=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.x=true;if(a){this.initDrag()}}else{this.drag.x=false;this.dragCleanup()}};Kinetic.Shape.prototype.draggableY=function(b){if(b){var a=!this.drag.x&&!this.drag.y;this.drag.y=true;if(a){this.initDrag()}}else{this.drag.y=false;this.dragCleanup()}};Kinetic.Shape.prototype.getZIndex=function(){return this.index};Kinetic.Shape.prototype.setScale=function(b,a){if(a){this.scale.x=b;this.scale.y=a}else{this.scale.x=b;this.scale.y=b}};Kinetic.Shape.prototype.setPosition=function(a,b){this.x=a;this.y=b};Kinetic.Shape.prototype.getPosition=function(){return{x:this.x,y:this.y}};Kinetic.Shape.prototype.move=function(a,b){this.x+=a;this.y+=b};Kinetic.Shape.prototype.setRotation=function(a){this.rotation=a};Kinetic.Shape.prototype.rotate=function(a){this.rotation+=a};Kinetic.Shape.prototype.on=function(c,e){var h=c.split(" ");for(var d=0;d<h.length;d++){var i=h[d];var b=(i.indexOf("touch")==-1)?"on"+i:i;var g=b.split(".");var f=g[0];var a=g.length>1?g[1]:"";if(!this.eventListeners[f]){this.eventListeners[f]=[]}this.eventListeners[f].push({name:a,func:e})}};Kinetic.Shape.prototype.addEventListener=function(a,b){this.on(a,b)};Kinetic.Shape.prototype.off=function(d){var e=(d.indexOf("touch")==-1)?"on"+d:d;var f=e.split(".");var b=f[0];if(this.eventListeners[b]&&f.length>1){var a=f[1];for(var c=0;c<this.eventListeners[b].length;c++){if(this.eventListeners[b][c].name==a){this.eventListeners[b].splice(c,1);if(this.eventListeners[b].length==0){this.eventListeners[b]=undefined}break}}}else{this.eventListeners[b]=undefined}};Kinetic.Shape.prototype.removeEventListener=function(a){this.off(a)};Kinetic.Shape.prototype.show=function(){this.visible=true};Kinetic.Shape.prototype.hide=function(){this.visible=false};Kinetic.Shape.prototype.moveToTop=function(){var b=this.stage;var a=this.index;this.layer.shapes.splice(a,1);this.layer.shapes.push(this);this.layer.setIndices()};Kinetic.Shape.prototype.getLayer=function(){return this.layer};Kinetic.Shape.prototype.moveToLayer=function(c){var b=this.stage;var a=this.index;this.layer.shapes.splice(a,1);b.layers[c].shapes.push(this);this.layer=b.layers[c];this.index=this.layer.shapes.length-1;this.layer.setIndices();b.layers[c].setIndices()};Kinetic.Image=function(d,b){this.image=d.image;var g=d.x?d.x:0;var f=d.y?d.y:0;var c=d.width?d.width:d.image.width;var i=d.height?d.height:d.image.height;var a=function(){var j=this.getContext();j.drawImage(this.image,g,f,c,i);j.beginPath();j.rect(g,f,c,i);j.closePath()};var e=new Kinetic.Shape(a,b);for(var h in e){this[h]=e[h]}};Kinetic.Image.prototype.setImage=function(a){this.image=a};